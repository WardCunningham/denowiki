<html>

<head>
    <style>
        body {
            background: #eeeeee url("/crosses.png");
            overflow: hidden;
            padding: 0;
            margin: 0;
            font-family: "Helvetica Neue", Verdana, helvetica, Arial, Sans;
            line-height: 1.3;
            color: #333333;
        }

        wiki-root {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        footer {
            border-top: 1px solid #3d3c43;
            box-shadow: inset 0px 0px 7px rgba(0, 0, 0, 0.8);
            background: #eeeeee url("noise.png");
            flex-basis: 20px;
            padding: 10px;
            font-size: 80%;
            color: #ccdcd2;
        }

        wiki-lineup {
            flex: 1;
            display: flex;
            flex-direction: row;
        }

        wiki-page {
            flex: 0 0 480px;
            background-color: white;
            margin: 8px;
            box-shadow: 2px 1px 4px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        wiki-page.active {
            box-shadow: 2px 1px 24px rgba(0, 0, 0, 0.4);
            z-index: 10;
        }

    </style>
    <script type="text/javascript">
        class Reference extends HTMLElement {
            connectedCallback() {
                let shadow = this.attachShadow({ mode: "open" })
                let css = `
                    :host {
                        display: block;
                    }
                `
                let style = document.createElement("style")
                style.innerHTML = css
                shadow.appendChild(style)
                let p = document.createElement("p")
                let link = document.createElement("a")
                let site = this.getAttribute("site")
                let slug = this.getAttribute("slug")
                link.setAttribute("href", `javascript:wiki.loadRemotePage("${site}", "${slug}")`)
                link.appendChild(document.createTextNode(`${site}/${slug}`))
                p.appendChild(link)
                shadow.appendChild(p)
            }
        }
        customElements.define("wiki-reference", Reference);

        class Paragraph extends HTMLElement {
            connectedCallback() {
                let shadow = this.attachShadow({ mode: "open" })
                let css = `
                    :host {
                        display: block;
                    }
                `
                let style = document.createElement("style")
                style.innerHTML = css
                shadow.appendChild(style)
                let p = document.createElement("p")
                let slot = document.createElement("slot")
                p.appendChild(slot)
                shadow.appendChild(p)

                function asSlug(name) {
                    return name.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase()
                }
                let site = this.parentElement.getAttribute("site")
                this.innerHTML = this.innerHTML.replace(/\[\[(.*?)\]\]/g, (_full, match) => {
                    if (site) {
                        return `<a href='javascript:wiki.loadRemotePage("${site}", "${asSlug(match)}")'>${match}</a>`
                    }
                    return `<a href='javascript:wiki.loadPage("${asSlug(match)})"'>${match}</a>`
                })
                this.innerHTML = this.innerHTML.replace(/\[(.*)\]/g, (_full, match) => {
                    let [url, text] = match.split(" ")
                    return `<a href='${url}' target="_blank">${text}</a>`
                })
            }

            emit(json) {

            }

            bind() {

            }

            // export to toString or serialize?
            export() {
                return {
                    type: "paragraph",
                    id: "abc123",
                    text: this.text
                }
            }
        }
        customElements.define("wiki-paragraph", Paragraph);

        class Page extends HTMLElement {
            connectedCallback() {
                this.addEventListener("click", this.activate)
                let shadow = this.attachShadow({ mode: 'open' })
                let css = `
                    :host(.plugin)>.paper {
                        box-shadow: inset 0px 0px 40px 0px rgba(0, 220, 0, .5);
                    }

                    :host(.local)>.paper {
                        box-shadow: inset 0px 0px 40px 0px rgba(220, 180, 0, .7);
                    }

                    :host(.remote)>.paper {
                        box-shadow: inset 0px 0px 40px 0px rgba(0, 180, 220, .5);
                    }

                    :host(.recycler)>.paper {
                        box-shadow: inset 0px 0px 40px 0px rgba(220, 0, 0, .5)
                    }

                    .paper {
                        padding: 30px;
                        overflow: scroll;
                        top: 0;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        position: absolute;
                    }

                    .flag {
                        margin-right: 6px;
                        margin-bottom: -6px;
                    }
                `
                let style = document.createElement("style")
                style.innerHTML = css
                shadow.appendChild(style)

                let site = this.getAttribute("site")
                if (site) {
                    this.classList.add("remote")
                }

                let title = this.getAttribute("title")
                if (!title) {
                    title = "empty"
                }

                // TODO: Style if remote or ghost or local
                let paper = document.createElement("div")
                paper.className = "paper"
                shadow.appendChild(paper)

                // TODO: Put header into its own web component
                // <wiki-header title="" flag="" url=""/>
                let header = document.createElement("div")
                let h1 = document.createElement("h1")
                h1.title = title

                let span = document.createElement("span")

                let prefix = ""
                if (site) {
                    // TODO: Descend into madness by detecting http vs https
                    prefix = `http://${site}`
                }
                let flagLink = document.createElement("a")
                flagLink.setAttribute("href", `${prefix}/view/welcome-visitors`)
                flagLink.setAttribute("target", "")

                let flag = document.createElement("img")
                flag.classList.add("flag")
                flag.setAttribute("src", `${prefix}/favicon.png`)

                flagLink.appendChild(flag)
                span.appendChild(flagLink)
                span.appendChild(document.createTextNode(title))
                h1.appendChild(span)
                header.appendChild(h1)
                paper.appendChild(header)

                let slot = document.createElement("slot")
                paper.appendChild(slot)
            }

            disconnectedCallback() { }

            attributeChangedCallback(attrName, oldValue, newValue) {
                if (attrName == "TITLE") {
                }
            }

            static get observedAttributes() {
                return ["title"]
            }

            get title() {
                this.getElementsByTagName("title")[0]
            }

            addParagraph(text) {
                let paragraph = document.createElement("wiki-paragraph")
                paragraph.textContent = text
                this.appendChild(paragraph)
            }

            addReference(site, slug) {
                let ref = document.createElement("wiki-reference")
                ref.setAttribute("site", site)
                ref.setAttribute("slug", slug)
                this.appendChild(ref)
            }

            activate() {
                this.scrollIntoViewIfNeeded()
                let actives = document.getElementsByClassName("active")
                for (let active of actives) {
                    active.classList.remove("active")
                }
                this.classList.add("active")
            }
        }
        customElements.define("wiki-page", Page);

        class Lineup extends HTMLElement {
            connectedCallback() {
                this.setAttribute("tabindex", -1)
                this.addEventListener("keydown", (ev) => {
                    let actives = document.getElementsByClassName("active")
                    if (actives.length == 0) {
                        actives = [this.pages[this.pages.length - 1]]
                    }
                    let active = actives[0]
                    let index = [...this.pages].indexOf(active)
                    let max = this.pages.length - 1
                    let min = 0
                    if (ev.key == "ArrowLeft") {
                        if (index > min) {
                            this.pages[index - 1].activate()
                        }
                    }
                    if (ev.key == "ArrowRight") {
                        if (index < max) {
                            this.pages[index + 1].activate()
                        }
                    }
                })
            }

            get pages() {
                return this.getElementsByTagName("wiki-page")
            }

            newPage(title, site) {
                let page = new Page()
                if (site) {
                    page.setAttribute("site", site)
                }
                page.setAttribute("title", title)
                this.appendChild(page)
                return page
            }

            closePageByIndex(index) {
                this.pages[index].remove()
            }
        }
        customElements.define("wiki-lineup", Lineup);

        class Wiki extends HTMLElement {
            constructor() {
                super()
                window.wiki = this
            }

            connectedCallback() {
            }

            get lineup() {
                return this.getElementsByTagName("wiki-lineup")[0]
            }

            get pages() {
                return this.lineup.pages
            }

            async loadPage(slug) {
                let res = await fetch(`/${slug}.json`)
                let page = await this.renderPage(res)
                page.scrollIntoViewIfNeeded()
            }

            async loadRemotePage(site, slug) {
                let res = await fetch(`http://${site}/${slug}.json`)
                let page = await this.renderPage(res, site)
                page.scrollIntoViewIfNeeded()
            }

            async renderPage(res, site) {
                let json = await res.json()
                console.log(json)
                let page = this.lineup.newPage(json.title, site)
                for (let pageContent of json.story) {
                    if (pageContent.type == "paragraph") {
                        page.addParagraph(pageContent.text)
                    }
                    else if (pageContent.type == "reference") {
                        page.addReference(pageContent.site, pageContent.slug)
                    }
                    else {
                        page.addParagraph(`Unknown type: ${pageContent.type}`)
                    }
                }
                return page
            }
        }
        customElements.define("wiki-root", Wiki);

        document.addEventListener("readystatechange", (e) => {
            if (event.target.readyState != "complete") {
                return
            }
            let wiki = document.getElementsByTagName("wiki-root")[0]
            let welcome = wiki.lineup.newPage("Web Components API")
            welcome.addParagraph("Exploring a possible web components based wiki client side API")
            welcome.addReference("wiki.randombits.xyz", "welcome-visitors")
            wiki.loadPage("deno-sites")
        })
    </script>
</head>

<body>
    <wiki-root>
        <wiki-lineup>
        </wiki-lineup>
        <footer></footer>
    </wiki-root>
</body>

</html>