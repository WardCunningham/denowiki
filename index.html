<html>

<head>
    <style>
        body {
            background: #eeeeee url("/crosses.png");
            overflow: hidden;
            padding: 0;
            margin: 0;
            font-family: "Helvetica Neue", Verdana, helvetica, Arial, Sans;
            line-height: 1.3;
            color: #333333;
        }

        wiki-wiki {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        footer {
            border-top: 1px solid #3d3c43;
            box-shadow: inset 0px 0px 7px rgba(0, 0, 0, 0.8);
            background: #eeeeee url("noise.png");
            flex-basis: 20px;
            padding: 10px;
            font-size: 80%;
            color: #ccdcd2;
        }

        wiki-neighborhood:hover {
            border-top: 1px solid #3d3c43;
            box-shadow: inset 0px 0px 7px rgba(0, 0, 0, 0.8);
            background: #eeeeee url("noise.png");
            flex-basis: 20px;
            padding: 10px;
            font-size: 80%;
            color: #ccdcd2;
            max-height: 500px;
            position: absolute;
            right: 10;
            bottom: 10;
        }

        wiki-neighborhood {
            width: 200px;
            max-height: 16px;
            float: right;
        }

        wiki-lineup {
            flex: 1;
            display: flex;
            flex-direction: row;
            overflow: scroll;
            scrollbar-width: none;
        }

        wiki-lineup::-webkit-scrollbar {
            display: none;
        }

        wiki-page {
            flex: 0 0 480px;
            background-color: white;
            margin: 8px;
            box-shadow: 2px 1px 4px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        wiki-page.active {
            box-shadow: 2px 1px 24px rgba(0, 0, 0, 0.4);
            z-index: 10;
        }
    </style>
    <script type="text/javascript">
        window.plugins = {}
        function registerPlugin(name, cls) {
            window.plugins[name] = cls
            customElements.define(`wiki-${name}`, cls);
        }

        class Roster extends HTMLElement {
            connectedCallback() {
                if (this.inited) return
                this.inited = true
                let shadow = this.attachShadow({ mode: "open" })
                let css = `
                    :host {
                        display: block;
                        background-color: #eee;
                        padding: 15px;
                    }
                    img {
                        width: 16px;
                        height: 16px;
                    }
                `
                let style = document.createElement("style")
                style.innerHTML = css
                shadow.appendChild(style)
                let p = document.createElement("p")
                console.log(this, this.children, this.childNodes)
                if (this.childNodes.length > 0) {
                    let rosterContent = this.childNodes[0].nodeValue
                    for (let line of rosterContent.split("\n")) {
                        let flag = document.createElement("img")
                        flag.setAttribute("src", `http://${line}/favicon.png`)
                        flag.setAttribute("title", line)
                        p.appendChild(flag)
                    }
                }
                shadow.appendChild(p)
            }

            render(json) {
                console.log("Rendering roster", json)
                let text = document.createTextNode(json.text)
                this.appendChild(text)
            }
        }
        registerPlugin("roster", Roster);

        class Reference extends HTMLElement {
            connectedCallback() {
                if (this.inited) return
                this.inited = true
                let shadow = this.attachShadow({ mode: "open" })
                let css = `
                    :host {
                        display: block;
                    }
                    img {
                        width: 16px;
                        height: 16px;
                        margin-right: 6px;
                        margin-bottom: -3px;
                    }
                `
                let style = document.createElement("style")
                style.innerHTML = css
                shadow.appendChild(style)
                let p = document.createElement("p")
                let link = document.createElement("a")
                let site = this.getAttribute("site")
                let slug = this.getAttribute("slug")
                let title = this.getAttribute("title")
                let text = this.getAttribute("text")
                let flag = document.createElement("img")
                flag.setAttribute("src", `http://${site}/favicon.png`)
                p.appendChild(flag)
                link.setAttribute("href", `javascript:wiki.loadRemotePage("${site}", "${slug}")`)
                function asTitle(slug) {
                    return slug.replace(/-/g, ' ')
                }
                link.appendChild(document.createTextNode(title))
                p.appendChild(link)
                let desc = document.createElement('span')
                desc.textContent = ` - ${text}`
                p.appendChild(desc)
                shadow.appendChild(p)

                let wiki = document.getElementsByTagName("wiki-wiki")[0]
                wiki.neighborhood.add(site)
            }

            render(json) {
                this.setAttribute("site", json.site)
                this.setAttribute("slug", json.slug)
                this.setAttribute("title", json.title)
                this.setAttribute("text", json.text)
            }
        }
        registerPlugin("reference", Reference);

        class Paragraph extends HTMLElement {
            connectedCallback() {
                if (this.inited) return
                this.inited = true
                let shadow = this.attachShadow({ mode: "open" })
                let css = `
                    :host {
                        display: block;
                    }
                `
                let style = document.createElement("style")
                style.innerHTML = css
                shadow.appendChild(style)
                let p = document.createElement("p")
                let slot = document.createElement("slot")
                p.appendChild(slot)
                shadow.appendChild(p)

                function asSlug(name) {
                    return name.replace(/\s/g, '-').replace(/[^A-Za-z0-9-]/g, '').toLowerCase()
                }
                let site = this.parentElement.getAttribute("site")
                this.innerHTML = this.innerHTML.replace(/\[\[(.*?)\]\]/g, (_full, match) => {
                    if (site) {
                        return `<a href='javascript:wiki.loadRemotePage("${site}", "${asSlug(match)}")'>${match}</a>`
                    }
                    return `<a href='javascript:wiki.loadPage("${asSlug(match)})"'>${match}</a>`
                })
                this.innerHTML = this.innerHTML.replace(/\[(.*)\]/g, (_full, match) => {
                    let [url, text] = match.split(" ")
                    return `<a href='${url}' target="_blank">${text}</a>`
                })
            }

            render(json) {
                this.textContent = json.text
            }

            bind() {

            }

            // export to toString or serialize?
            export() {
                return {
                    type: "paragraph",
                    id: "abc123",
                    text: this.text
                }
            }
        }
        registerPlugin("paragraph", Paragraph);

        class Neighboorhood extends HTMLElement {
            connectedCallback() {
                if (this.inited) return
                this.inited = true
                this.neighbors = new Set()
                let shadow = this.attachShadow({ mode: "open" })
                let css = `
                    :host {
                        display: block;
                        overflow: hidden;
                    }

                    img {
                        padding-left: 2px;
                        padding-bottom: 2px;
                        width: 16px;
                        height: 16px;
                        display: inline-block;
                        float: right;
                    }

                    a {
                        display: inline-block;
                        float: right;
                    }
                `
                let style = document.createElement("style")
                style.innerHTML = css
                shadow.appendChild(style)
                let link = document.createElement("a")
                link.setAttribute("href", "javascript:wiki.showNeighborhood()")
                link.appendChild(document.createTextNode(">>"))
                shadow.appendChild(link)
                // TODO: Remove this hardcoded sitename
                this.add("localhost:8000")
            }

            add(site) {
                if (this.neighbors.has(site)) return
                let flag = document.createElement("img")
                flag.setAttribute("src", `http://${site}/favicon.png`)
                flag.setAttribute("title", site)
                this.shadowRoot.appendChild(flag)
                this.neighbors.add(site)
            }
        }
        customElements.define("wiki-neighborhood", Neighboorhood)

        class Page extends HTMLElement {
            connectedCallback() {
                if (this.inited) return
                this.inited = true
                this.addEventListener("click", this.activate)
                let shadow = this.attachShadow({ mode: 'open' })
                let css = `
                    :host(.plugin)>.paper {
                        box-shadow: inset 0px 0px 40px 0px rgba(0, 220, 0, .5);
                    }

                    :host(.local)>.paper {
                        box-shadow: inset 0px 0px 40px 0px rgba(220, 180, 0, .7);
                    }

                    :host(.remote)>.paper {
                        box-shadow: inset 0px 0px 40px 0px rgba(0, 180, 220, .5);
                    }

                    :host(.recycler)>.paper {
                        box-shadow: inset 0px 0px 40px 0px rgba(220, 0, 0, .5)
                    }

                    .paper {
                        padding: 30px;
                        overflow: scroll;
                        top: 0;
                        bottom: 0;
                        left: 0;
                        right: 0;
                        position: absolute;
                    }
                    .flag {
                        margin-right: 6px;
                        margin-bottom: -6px;
                    }

                    :host(.drag-target) {
                        border-left: 1px solid blue;
                    }
                `
                let style = document.createElement("style")
                style.innerHTML = css
                shadow.appendChild(style)

                this.setAttribute("draggable", true)
                this.addEventListener("dragstart", this.dragStart)
                this.addEventListener("dragenter", this.dragEnter)
                this.addEventListener("dragover", this.dragOver)
                this.addEventListener("dragleave", this.dragLeave)
                this.addEventListener("dragend", this.dragEnd)
                this.addEventListener("drop", this.drop)

                let site = this.getAttribute("site")
                if (site) {
                    this.classList.add("remote")
                }

                let title = this.getAttribute("title")
                if (!title) {
                    title = "empty"
                }

                // TODO: Style if remote or ghost or local
                let paper = document.createElement("div")
                paper.className = "paper"
                shadow.appendChild(paper)

                // TODO: Put header into its own web component
                // <wiki-header title="" flag="" url=""/>
                let header = document.createElement("div")
                let h1 = document.createElement("h1")
                h1.title = title

                let span = document.createElement("span")

                let prefix = ""
                if (site) {
                    // TODO: Descend into madness by detecting http vs https
                    prefix = `http://${site}`
                }
                let flagLink = document.createElement("a")
                flagLink.setAttribute("href", `${prefix}/view/welcome-visitors`)
                flagLink.setAttribute("target", "")

                let flag = document.createElement("img")
                flag.classList.add("flag")
                flag.setAttribute("src", `${prefix}/favicon.png`)

                flagLink.appendChild(flag)
                span.appendChild(flagLink)
                span.appendChild(document.createTextNode(title))
                h1.appendChild(span)
                header.appendChild(h1)
                paper.appendChild(header)

                let slot = document.createElement("slot")
                paper.appendChild(slot)
            }

            dragStart(event) {
                console.log("drag start:", event)
                event.dataTransfer.setData("pageIndex", this.parentElement.pageIndex(this))
            }

            dragEnter(event) {
                console.log("drag enter:", event)
                event.dataTransfer.dropEffect = "move"
                this.classList.add("drag-target")
                return false
            }

            dragOver(event) {
                event.preventDefault()
            }

            dragLeave(event) {
                console.log("drag leave:", event)
                this.classList.remove("drag-target")
            }

            dragEnd(event) {
                console.log("drag end:", event)
                if (event.pageY < 0 && this.parentElement.pages.length > 1) {
                    this.remove()
                }
            }

            drop(event) {
                console.log("drop:", event)
                this.classList.remove("drag-target")
                let pageIndex = event.dataTransfer.getData("pageIndex")
                let page = this.parentElement.pages[pageIndex]
                this.parentElement.insertBefore(page, this)
            }

            disconnectedCallback() { }

            attributeChangedCallback(attrName, oldValue, newValue) {
                if (attrName == "TITLE") {
                }
            }

            static get observedAttributes() {
                return ["title"]
            }

            get title() {
                this.getElementsByTagName("title")[0]
            }

            addParagraph(text) {
                let paragraph = document.createElement("wiki-paragraph")
                paragraph.textContent = text
                this.appendChild(paragraph)
            }

            addReference(site, slug, title, text) {
                let ref = document.createElement("wiki-reference")
                ref.setAttribute("site", site)
                ref.setAttribute("slug", slug)
                ref.setAttribute("title", title)
                ref.setAttribute("text", text)
                // or...
                // ref.render({ site, slug, title, text})
                this.appendChild(ref)
            }

            activate() {
                this.scrollIntoViewIfNeeded()
                let actives = document.getElementsByClassName("active")
                for (let active of actives) {
                    active.classList.remove("active")
                }
                this.classList.add("active")
            }
        }
        customElements.define("wiki-page", Page);

        class Lineup extends HTMLElement {
            connectedCallback() {
                if (this.inited) return
                this.inited = true
                this.setAttribute("tabindex", -1)
                this.addEventListener("keydown", (ev) => {
                    let actives = document.getElementsByClassName("active")
                    if (actives.length == 0) {
                        actives = [this.pages[this.pages.length - 1]]
                    }
                    let active = actives[0]
                    let index = [...this.pages].indexOf(active)
                    let max = this.pages.length - 1
                    let min = 0
                    if (ev.key == "ArrowLeft") {
                        if (index > min) {
                            this.pages[index - 1].activate()
                        }
                    }
                    if (ev.key == "ArrowRight") {
                        if (index < max) {
                            this.pages[index + 1].activate()
                        }
                    }
                })
            }

            get pages() {
                return this.getElementsByTagName("wiki-page")
            }

            newPage(title, site) {
                let page = new Page()
                if (site) {
                    page.setAttribute("site", site)
                }
                page.setAttribute("title", title)
                this.appendChild(page)
                return page
            }

            closePageByIndex(index) {
                this.pages[index].remove()
            }

            pageIndex(targetPage) {
                let index = 0
                for (let page of this.pages) {
                    if (page == targetPage) {
                        return index
                    }
                    index += 1
                }
                return -1
            }
        }
        customElements.define("wiki-lineup", Lineup);

        class Wiki extends HTMLElement {
            constructor() {
                super()
                window.wiki = this
            }

            connectedCallback() {
                this.setAttribute("tabindex", -1)
                this.addEventListener("keyup", this.handleShortcut)

                let dialog = document.createElement("dialog")
                dialog.setAttribute("style", "z-index: 1000;")
                dialog.addEventListener("close", this.open)

                let form = document.createElement("form")
                form.setAttribute("method", "dialog")
                form.setAttribute("style", "margin: 0;")
                dialog.appendChild(form)

                let input = document.createElement("input")
                input.setAttribute("type", "text")
                form.appendChild(input)

                this.appendChild(dialog)
            }

            handleShortcut(event) {
                if (event.altKey && event.key == "o") {
                    console.log("open dialog")
                    let dialog = this.getElementsByTagName("dialog")[0]
                    dialog.setAttribute("open", "")
                    let input = dialog.getElementsByTagName("input")[0]
                    event.preventDefault()
                    input.focus()
                }
            }

            open(event) {
                console.log("opening:", this)
                let input = this.getElementsByTagName("input")[0]
                let path = input.value
                let site = "localhost:8000"
                let slug = path
                if (path.indexOf(":") != -1) {
                    [site, slug] = path.split(":")
                }
                console.log("opening:", site, slug)
                this.parentElement.loadRemotePage(site, slug)
            }

            get lineup() {
                return this.getElementsByTagName("wiki-lineup")[0]
            }

            get pages() {
                return this.lineup.pages
            }

            get neighborhood() {
                return this.getElementsByTagName("footer")[0].getElementsByTagName("wiki-neighborhood")[0]
            }

            async loadPage(slug) {
                let res = await fetch(`/${slug}.json`)
                let page = await this.renderPage(res)
                page.scrollIntoViewIfNeeded()
            }

            async loadRemotePage(site, slug) {
                let res = await fetch(`http://${site}/${slug}.json`)
                let page = await this.renderPage(res, site)
                page.scrollIntoViewIfNeeded()
            }

            async renderPage(res, site) {
                let json = await res.json()
                console.log(json)
                let page = this.lineup.newPage(json.title, site)
                for (let pageContent of json.story) {
                    let plugin = window.plugins[pageContent.type]
                    if (plugin) {
                        let element = new plugin()
                        element.render(pageContent)
                        page.appendChild(element)
                    }
                    else {
                        page.addParagraph(`Unknown type: ${pageContent.type}`)
                    }
                }
                return page
            }

            showNeighborhood() {
                let page = this.lineup.newPage("Neighborhood")
                for (let neighbor of this.neighborhood.neighbors) {
                    page.addReference(neighbor, "welcome-visitors", "Welcome Visitors", neighbor)
                }
                page.activate()
            }
        }
        customElements.define("wiki-wiki", Wiki);

        document.addEventListener("readystatechange", (e) => {
            if (event.target.readyState != "complete") {
                return
            }
            let wiki = document.getElementsByTagName("wiki-wiki")[0]
            let welcome = wiki.lineup.newPage("Web Components API")
            welcome.addParagraph("Exploring a possible web components based wiki client side API")
            welcome.addReference("wiki.randombits.xyz", "welcome-visitors", "Welcome Visitors", "Link to an external site")
            wiki.loadPage("deno-sites")
        })
    </script>
</head>

<body>
    <wiki-wiki>
        <wiki-lineup>
        </wiki-lineup>
        <footer>
            <wiki-neighborhood></wiki-neighborhood>
        </footer>
    </wiki-wiki>
</body>

</html>